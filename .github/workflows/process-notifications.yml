name: Process Notifications
on:
  schedule:
    - cron: '*/30 * * * *'  # A cada 30 minutos
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  process-notifications:
    runs-on: ubuntu-latest
    name: Process pending notifications
    steps:
      - name: Process notifications
        run: |
          echo "üöÄ Iniciando processamento de notifica√ß√µes..."
          
          # URL da aplica√ß√£o no Railway
          APP_URL="https://growspace-backend-production.up.railway.app"
          
          # Fazer requisi√ß√£o para processar notifica√ß√µes
          response=$(curl -s -w "\n%{http_code}" -X GET "$APP_URL/email/process-and-send")
          
          # Separar body da resposta do status code
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "üìä Status Code: $http_code"
          echo "üìã Resposta:"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          
          # Verificar se foi bem-sucedido
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Processamento conclu√≠do com sucesso!"
            
            # Extrair estat√≠sticas
            processed=$(echo "$body" | jq -r '.data.processed // 0')
            sent=$(echo "$body" | jq -r '.data.sent // 0')
            failed=$(echo "$body" | jq -r '.data.failed // 0')
            success_rate=$(echo "$body" | jq -r '.data.successRate // 0')
            
            echo "üìä Estat√≠sticas:"
            echo "   üìß Processadas: $processed"
            echo "   ‚úÖ Enviadas: $sent"
            echo "   ‚ùå Falhas: $failed"
            echo "   üìà Taxa de sucesso: ${success_rate}%"
            
            if [ "$failed" -gt 0 ]; then
              echo "‚ö†Ô∏è  Algumas notifica√ß√µes falharam!"
              exit 1
            fi
          else
            echo "‚ùå Erro no processamento: HTTP $http_code"
            echo "$body"
            exit 1
          fi 